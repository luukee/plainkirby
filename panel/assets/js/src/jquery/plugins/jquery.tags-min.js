!function($){$.cursor=function(t){var e=$(t),n=e[0],i=e.val();if(!n.createTextRange)return n.selectionEnd;var a=document.selection.createRange().duplicate();return a.moveEnd("character",i.length),""==a.text?i.length:i.lastIndexOf(a.text)};var t=function(t){var e=this;return this.source=$(t),this.element=$("<div />"),this.input=$('<input class="tag-input" type="text" autocomplete="off" />'),this.tags=[],this.elements={},this.cursor=0,this.disabled=!1,this.autocomplete=this.source.data("url"),this.lowercase=this.source.data("lowercase"),this.separator=this.source.data("separator"),this.lowercase&&this.input.css("text-transform","lowercase"),this.separator||(this.separator=","),this.keys=function(t,e){t.on("keydown",function(t){if(e[t.keyCode])return e[t.keyCode](t)})},this.next=function(t){return e.get(t).next()},this.prev=function(t){return e.get(t).prev()},this.first=function(){return e.element.find(".tag").first()},this.last=function(){return e.element.find(".tag").last()},this.goto=function(t,n){e[t](n).trigger("focus")},this.clean=function(t){var t=$.trim(t);return e.lowercase&&(t=t.toLowerCase()),t},this.get=function(t){return e.elements.filter(function(e,n){return $(this).data("tag")==t.toLowerCase()})},this.select=function(t){return e.get(t).trigger("focus")},this.deselect=function(t){return e.get(t).trigger("blur")},this.store=function(){e.source.val(e.tags.join(e.separator)).trigger("change")},this.add=function(t){t||(t=e.input.val());var t=e.clean(t),n=new RegExp(e.separator);if(t.match(n))return void $.each(t.split(e.separator),function(t,n){e.add(n)});if("array"==$.type(t))return void $.each(t,function(t,n){e.add(n)});if(!t||0==t.length||-1!=$.inArray(t,e.tags))return!1;e.tags.push(t);var i=$('<span data-tag="'+t.toLowerCase()+'" tabindex="-1" class="tag"></span>'),a=$('<i class="tag-x">&times;</i>'),r=$('<button class="tag-label" type="button"></button>').text(t);i.append(r).append(a),i.on("focus",function(){r.focus()}),i.on("click",function(t){t.stopPropagation()}),a.on("click",function(n){e.remove(t)}),e.keys(r,{8:function(){return e.remove(t),!1},27:function(){e.focus()},37:function(){return e.goto("prev",t),!1},39:function(){return e.goto("next",t),!1}}),e.input.before(i),e.elements=e.element.find(".tag"),e.input.val(""),e.store(),e.autocomplete&&e.input.data("autocomplete").ignore(t),e.element.trigger("tags:add")},this.focus=function(){e.input.trigger("focus")},this.remove=function(t){if(!e.disabled){e.tags=$.grep(e.tags,function(e){return e!=t});var n=e.prev(t).data("tag");if(e.get(t).remove(),e.elements=e.element.find(".tag"),n)e.select(n);else{var n=e.first().data("tag");n?e.select(n):e.focus()}e.store(),e.autocomplete&&e.input.data("autocomplete").unignore(t),e.element.trigger("tags:remove")}},this.init=function(){return e.element.attr("class",e.source.attr("class")),e.input.attr("id",e.source.attr("id")),e.source.attr("type","hidden").attr("id","").removeClass(),e.source.before(e.element),e.element.append(e.input),e.autocomplete&&(e.input.data("url",e.autocomplete),e.input.data("limit",5),e.input.data("sticky",!0),e.input.autocomplete(),e.input.on("autocomplete:add",function(){e.add()}),e.element.on("tags:add",function(){e.input.data("autocomplete").close()})),e.element.on("click",function(t){e.focus()}),e.element.on("focusin",function(){e.element.addClass("input-is-focused"),e.element.trigger("tags:focus")}),e.element.on("focusout",function(){e.element.removeClass("input-is-focused"),e.element.trigger("tags:blur"),setTimeout(function(){0==e.element.has($(":focus")).length&&e.add()},100)}),e.element.parents(".form").find("input[type=submit]").on("click",function(t){e.add()}),e.measure=$("<div></div>").css({display:"inline","font-size":e.input.css("font-size"),"font-family":e.input.css("font-family"),padding:e.input.css("padding"),visibility:"hidden",position:"absolute",top:-1e4,left:-1e4}),$("body").append(e.measure),e.keys(e.input,{13:function(t){if(e.input.val().length>0&&!t.metaKey)return e.add(),!1},9:function(){return 0==e.input.val().length||(e.add(),!1)},188:function(){return e.add(),!1},8:function(){if(0==e.cursor)return e.goto("last"),!1},37:function(){if(0==e.cursor)return e.goto("last"),!1}}),e.input.on("keydown, keyup",function(){e.measure.text(e.input.val()),e.input.css("width",e.measure.outerWidth()+50),e.cursor=$.cursor(e.input)}),e.add(e.source.val()),e.source.attr("readonly")&&(e.disabled=!0,e.input.attr("readonly",!0).attr("tabindex",-1),e.element.find("button").attr("tabindex",-1)),e.element.trigger("tags:init"),{add:e.add,get:e.get,remove:e.remove,focus:e.focus,select:e.select,tags:function(){return e.tags},elements:function(){return e.elements},input:function(){return e.input}}},this.init()};$.fn.tags=function(){return this.each(function(){if($(this).data("tags"))return $(this).data("tags");var e=new t(this);return $(this).data("tags",e),e})}}(jQuery);